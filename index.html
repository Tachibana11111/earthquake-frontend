<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ª± ƒëo√°n ƒê·ªông ƒë·∫•t XGBoost</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .section h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .config-section {
            border-left: 4px solid #3b82f6;
        }
        .prediction-section {
            border-left: 4px solid #10b981;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.95em;
        }
        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }
        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        button {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            font-weight: 500;
        }
        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }
        .status-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        .status-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }
        #map {
            width: 100%;
            height: 600px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .output {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.6;
            border: 2px solid #e5e7eb;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        small {
            color: #6b7280;
            font-size: 0.85em;
            display: block;
            margin-top: 5px;
        }
        .api-info {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .api-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 10px;
        }
        .api-status.connected {
            background: #d1fae5;
            color: #065f46;
        }
        .api-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåç D·ª± ƒëo√°n ƒê·ªông ƒë·∫•t v·ªõi XGBoost</h1>
        
        <div class="section config-section">
            <h3>‚öôÔ∏è C·∫•u h√¨nh API</h3>
            <div class="api-info">
                <div class="input-group">
                    <label>üîó API URL:</label>
                    <input type="text" id="apiUrl" value="https://your-project.vercel.app" placeholder="https://your-project.vercel.app">
                    <small>
                        <strong>H∆∞·ªõng d·∫´n:</strong> Sau khi deploy backend l√™n Vercel, thay "your-project" b·∫±ng t√™n project c·ªßa b·∫°n.<br>
                        V√≠ d·ª•: https://earthquake-prediction-abc123.vercel.app
                    </small>
                </div>
                <button class="btn-primary" onclick="testConnection()">
                    <span id="testBtnText">üîç Ki·ªÉm tra k·∫øt n·ªëi</span>
                </button>
                <div id="apiStatus"></div>
            </div>
        </div>

        <div class="section prediction-section">
            <h3>üìç D·ª± ƒëo√°n ƒê·ªông ƒë·∫•t</h3>
            
            <div class="grid">
                <div class="input-group">
                    <label>üåê Vƒ© ƒë·ªô (Latitude):</label>
                    <input type="number" id="latitude" value="38.297" step="0.001" min="30" max="45">
                    <small>Gi·ªõi h·∫°n: 30¬∞ - 45¬∞ (Nh·∫≠t B·∫£n)</small>
                </div>
                <div class="input-group">
                    <label>üåê Kinh ƒë·ªô (Longitude):</label>
                    <input type="number" id="longitude" value="142.373" step="0.001" min="130" max="150">
                    <small>Gi·ªõi h·∫°n: 130¬∞ - 150¬∞ (Nh·∫≠t B·∫£n)</small>
                </div>
                <div class="input-group">
                    <label>üìè ƒê·ªô s√¢u (Depth km):</label>
                    <input type="number" id="depth" value="29.0" step="0.1" min="0" max="700">
                    <small>Gi·ªõi h·∫°n: 0 - 700 km</small>
                </div>
            </div>
            
            <div class="input-group">
                <label>üó∫Ô∏è Lo·∫°i b·∫£n ƒë·ªì:</label>
                <select id="mapStyle">
                    <option value="OpenStreetMap">B·∫£n ƒë·ªì S√°ng (M·∫∑c ƒë·ªãnh)</option>
                    <option value="Satellite">·∫¢nh V·ªá tinh</option>
                    <option value="Terrain">ƒê·ªãa h√¨nh N√∫i & Bi·ªÉn</option>
                    <option value="Ocean">B·∫£n ƒë·ªì Bi·ªÉn</option>
                </select>
            </div>

            <button class="btn-success" id="predictBtn" onclick="predict()">
                <span id="predictBtnText">üîç D·ª± ƒëo√°n & Ph√¢n t√≠ch</span>
            </button>
            
            <div id="resultOutput"></div>
            <div id="map"></div>
        </div>
    </div>

    <script>
        let map = null;
        const JAPAN_TRENCH = [
            [141.8, 34.1], [142.3, 35.5], [143.1, 36.5], [143.7, 37.5],
            [144.0, 38.5], [144.2, 39.5], [144.4, 40.5], [144.7, 41.0]
        ];
        
        const API_BASE = () => document.getElementById('apiUrl').value.replace(/\/$/, '');

        async function testConnection() {
            const testBtn = document.getElementById('testBtnText');
            const apiStatus = document.getElementById('apiStatus');
            
            testBtn.innerHTML = '<span class="loading"></span> ƒêang ki·ªÉm tra...';
            
            try {
                const response = await fetch(`${API_BASE()}/api/predict`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude: 38.0, longitude: 142.0, depth: 30.0 })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    apiStatus.innerHTML = '<div class="api-status connected">‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!</div>';
                    document.getElementById('predictBtn').disabled = false;
                } else {
                    apiStatus.innerHTML = '<div class="api-status disconnected">‚ùå API tr·∫£ v·ªÅ l·ªói</div>';
                }
            } catch (error) {
                apiStatus.innerHTML = `<div class="api-status disconnected">‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c: ${error.message}</div>`;
            }
            
            testBtn.innerHTML = 'üîç Ki·ªÉm tra k·∫øt n·ªëi';
        }

        async function predict() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            const depth = parseFloat(document.getElementById('depth').value);
            const mapStyle = document.getElementById('mapStyle').value;

            if (lat < 30 || lat > 45 || lon < 130 || lon > 150 || depth < 0 || depth > 700) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p gi√° tr·ªã trong ph·∫°m vi h·ª£p l·ªá!');
                return;
            }

            const predictBtn = document.getElementById('predictBtnText');
            predictBtn.innerHTML = '<span class="loading"></span> ƒêang d·ª± ƒëo√°n...';
            document.getElementById('resultOutput').innerHTML = '<div class="status status-info">‚è≥ ƒêang g·ª≠i y√™u c·∫ßu ƒë·∫øn API...</div>';

            try {
                const response = await fetch(`${API_BASE()}/api/predict`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        latitude: lat,
                        longitude: lon,
                        depth: depth
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const pred = result.prediction;
                    
                    const output = `

PH√ÇN T√çCH T·ªåA ƒê·ªò: Vƒ© ƒë·ªô = ${lat}, Kinh ƒë·ªô = ${lon}, ƒê·ªô s√¢u = ${depth} km

üìä K·∫æT QU·∫¢ D·ª∞ ƒêO√ÅN (XGBoost):
   ‚Ä¢ Ph√¢n lo·∫°i: L·ªõp ${pred.class} (${pred.label})
   ‚Ä¢ Kho·∫£ng c∆∞·ªùng ƒë·ªô: ${pred.magnitude_range}
   ‚Ä¢ C∆∞·ªùng ƒë·ªô ƒë·ªãa ch·∫•n (Shindo): ${pred.shindo}

üìè KHO·∫¢NG C√ÅCH ƒê·∫æN R√ÉNH NH·∫¨T B·∫¢N:
   ‚Ä¢ Kho·∫£ng c√°ch 3D: ${pred.distance.distance_3d} km
   ‚Ä¢ Kho·∫£ng c√°ch ngang: ${pred.distance.horizontal} km
   ‚Ä¢ Kho·∫£ng c√°ch d·ªçc (ƒë·ªô s√¢u): ${pred.distance.vertical} km

üéØ ƒê·ªò CH·∫ÆC CH·∫ÆN:
   ‚Ä¢ Nh·ªè: ${pred.confidence.minor}%
   ‚Ä¢ Trung b√¨nh: ${pred.confidence.moderate}%
   ‚Ä¢ L·ªõn: ${pred.confidence.major}%
                    `;

                    document.getElementById('resultOutput').innerHTML = `<div class="output">${output}</div>`;
                    drawMap(lat, lon, pred, mapStyle);
                } else {
                    document.getElementById('resultOutput').innerHTML = 
                        `<div class="status status-error">‚ùå L·ªói: ${result.error}</div>`;
                }
            } catch (error) {
                document.getElementById('resultOutput').innerHTML = 
                    `<div class="status status-error">‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c API: ${error.message}<br><small>Ki·ªÉm tra l·∫°i API URL ho·∫∑c ƒë·∫£m b·∫£o backend ƒëang ch·∫°y.</small></div>`;
            }

            predictBtn.innerHTML = 'üîç D·ª± ƒëo√°n & Ph√¢n t√≠ch';
        }

        function drawMap(lat, lon, prediction, mapStyle) {
            if (map) {
                map.remove();
            }

            map = L.map('map').setView([lat, lon], 7);

            let tileLayer;
            if (mapStyle === 'Satellite') {
                tileLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Esri'
                });
            } else if (mapStyle === 'Terrain') {
                tileLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Esri'
                });
            } else if (mapStyle === 'Ocean') {
                tileLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Esri'
                });
            } else {
                tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                });
            }
            tileLayer.addTo(map);

            L.polyline(JAPAN_TRENCH, {
                color: 'blue',
                weight: 3,
                opacity: 0.7
            }).addTo(map).bindPopup('R√£nh Nh·∫≠t B·∫£n');

            JAPAN_TRENCH.forEach(coord => {
                L.circleMarker(coord, {
                    radius: 5,
                    fillColor: 'blue',
                    color: 'darkblue',
                    weight: 2,
                    fillOpacity: 0.7
                }).addTo(map);
            });

            const nearestPoint = prediction.distance.nearest_point;
            L.polyline([[lat, lon], [nearestPoint.lat, nearestPoint.lon]], {
                color: 'red',
                weight: 2,
                opacity: 0.8,
                dashArray: '8, 8'
            }).addTo(map);

            L.circleMarker([nearestPoint.lat, nearestPoint.lon], {
                radius: 7,
                fillColor: 'red',
                color: 'darkred',
                weight: 2,
                fillOpacity: 1
            }).addTo(map).bindPopup('ƒêi·ªÉm g·∫ßn nh·∫•t tr√™n r√£nh');

            const icon = L.divIcon({
                html: '<div style="font-size: 32px;">‚≠ê</div>',
                className: '',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });
            
            L.marker([lat, lon], {icon: icon}).addTo(map)
                .bindPopup(`<b>D·ª± ƒëo√°n: ${prediction.label}</b><br>Kho·∫£ng c√°ch 3D: ${prediction.distance.distance_3d} km`);

            const midLat = (lat + nearestPoint.lat) / 2 + 0.3;
            const midLon = (lon + nearestPoint.lon) / 2;
            
            const distLabel = L.divIcon({
                html: `<div style="background: white; padding: 10px; border: 3px solid ${prediction.color}; border-radius: 8px; font-size: 12px; font-weight: bold; white-space: nowrap; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                    <div style="color: ${prediction.color}; font-size: 14px;">${prediction.distance.distance_3d} km</div>
                    <small style="color: #666;">(Ngang: ${prediction.distance.horizontal} km | D·ªçc: ${prediction.distance.vertical} km)</small>
                </div>`,
                className: '',
                iconSize: [150, 50]
            });
            
            L.marker([midLat, midLon], {icon: distLabel}).addTo(map);
        }

        window.onload = function() {
            document.getElementById('map').style.display = 'block';
            
            const savedApiUrl = localStorage.getItem('apiUrl');
            if (savedApiUrl) {
                document.getElementById('apiUrl').value = savedApiUrl;
            }
        };

        document.getElementById('apiUrl').addEventListener('change', function() {
            localStorage.setItem('apiUrl', this.value);
        });
    </script>
</body>
</html>